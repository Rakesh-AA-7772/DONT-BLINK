<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Don't Blink — Camera Edition</title>

  <!-- MediaPipe FaceMesh + helpers (used for blink detection) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.4/camera_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.4/drawing_utils.min.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main id="app">
    <header class="title">
      <!-- changed: create a title-row with a Rules button -->
      <div class="title-row">
        <img class="site-icon" src="i.png" alt="Site" />
        <h1>DON'T BLINK</h1>
        <a class="rules-link" href="rules.html" title="Rules">ABOUT GAME..(read this first)</a>
      </div>
    </header>

    <!-- embed banner (hidden by default; shown by JS if in iframe) -->
    <div id="embedBanner" style="display:none;max-width:420px;margin:8px auto;text-align:center;background:rgba(255,200,160,0.04);padding:8px;border-radius:8px;">
      <div style="margin-bottom:6px">This page is embedded and the browser blocks camera access. Open in a new tab to enable the camera.</div>
      <div>
        <button id="openTopBtn" style="padding:8px 12px;border-radius:8px;background:#ffd7b5;border:none;font-weight:700;">Open in new tab</button>
      </div>
    </div>

    <!-- changed: wrap stage + sidebar for side-by-side layout on wide screens -->
    <div class="main-grid">
      <section class="stage">
        <!-- video is visible and mirrored -->
        <video id="camera" autoplay muted playsinline></video>

        <!-- small avatar overlay (optional), you can remove if you prefer -->
        <div id="avatarOverlay" aria-hidden="true">
          <div class="small-eye left"></div>
          <div class="small-eye right"></div>
          <div class="small-mouth"></div>
        </div>
      </section>

      <!-- sidebar contains UI + leaderboard (placed to the right on wider screens) -->
      <aside class="sidebar">
        <section class="ui">
          <div id="status">Waiting for camera…</div>
          <div id="timer">0.0s</div>

          <!-- explicit user action to enable camera if autoplay blocked -->
          <div style="margin-top:8px">
            <button id="enableCameraBtn">Enable Camera</button>
          </div>

          <!-- NEW: meta row showing difficulty and high score -->
          <div class="meta">
            <div id="difficulty">Difficulty: 0</div>
            <div id="highscore">High: —</div>
          </div>

          <!-- NEW: player name + leaderboard -->
          <div class="name-row">
            <input id="playerName" placeholder="Your name (for leaderboard)" />
            <button id="lbSubmitBtn" disabled>Save</button>
          </div>

          <div class="controls">
            <button id="startBtn">Start</button>
            <button id="restartBtn" disabled>Restart</button>
            <!-- NEW: share button -->
            <button id="shareBtn" disabled title="Share your run">Share</button>
          </div>
          <div id="debug" aria-hidden="true"></div>
        </section>

        <!-- moved leaderboard into sidebar -->
        <div id="leaderboard" aria-live="polite">
          <div class="lb-title">Leaderboard</div>
          <div id="leaderboardList" class="lb-list"></div>
          <div class="lb-controls">
            <button id="lbResetBtn">Reset</button>
            <button id="lbExportBtn">Export</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script src="game.js"></script>

  <!-- hidden canvas used by game.js to sample frame brightness -->
  <canvas id="videoCanvas" width="160" height="120" style="display:none"></canvas>

  <!-- Made by credit (bottom-right) -->
  <div class="credit">
    <span>Made by Rakesh</span>
    <a id="discordLink" href="http://discord.com/users/1413816839846236280" target="_blank" rel="noreferrer" title="Discord">
      <!-- replaced inline SVG with local image d.jpg -->
      <img class="discord-img" src="d.jpg" alt="Discord" />
    </a>
  </div>
  <script>
    // If embedded, show banner and wire the button to open the app in a new tab.
    (function(){
      try {
        if (window.self !== window.top) {
          const b = document.getElementById('embedBanner');
          if (b) b.style.display = 'block';
          const btn = document.getElementById('openTopBtn');
          if (btn) btn.addEventListener('click', ()=> {
            window.open(window.location.href, '_blank', 'noopener');
          });
        }
      } catch(e){
        // ignore cross-origin errors
      }
    })();

    // about bar toggle (accessible)
    (function(){
      const bar = document.getElementById('aboutBar');
      const content = document.getElementById('aboutContent');
      if (!bar || !content) return;
      function toggle() {
        const expanded = bar.getAttribute('aria-expanded') === 'true';
        bar.setAttribute('aria-expanded', String(!expanded));
        content.hidden = expanded;
      }
      bar.addEventListener('click', toggle);
      bar.addEventListener('keydown', (e)=> { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }});
    })();
  </script>
</body>
</html>
